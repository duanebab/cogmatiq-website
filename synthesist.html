<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synthesist - Cogmatiq</title>
    <meta name="description" content="Cogmatiq is an AI-powered knowledge platform. Chat with the Synthesist to find, connect, and generate new insights from all your documents, notes, and data.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="msapplication-TileColor" content="#1A2533">
    <meta name="theme-color" content="#1A2533">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script src="/supabaseClient.js"></script>

    <style>
        /* ──────────────────────── 1. Global Reset & Palette ──────────────────────── */
        body {
            background-color: #151D2A;
            color: #E0E6E9;
            font-family: 'Share Tech Mono', monospace, 'Manrope', sans-serif;
            letter-spacing: 0.02em;
        }
        .accent-primary { color: #FF8C00; }
        .accent-secondary { color: #00F0FF; }

        /* ──────────────────────── 2. Buttons ──────────────────────── */
        .btn-primary {
            background-color: #FF8C00;
            color: #151D2A;
            border: 2px solid #FF8C00;
            box-shadow: 0 0 10px rgba(255,140,0,0.4);
            transition: all 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: transparent;
            color: #FF8C00;
            box-shadow: 0 0 15px rgba(255,140,0,0.7);
        }

        /* ──────────────────────── 3. Cards ──────────────────────── */
        .card {
            background: #293345;
            border: 1px solid #00F0FF;
            box-shadow: 0 0 8px rgba(0,240,255,0.2);
        }

        /* ──────────────────────── 4. Scrollbars ──────────────────────── */
        #chat-container::-webkit-scrollbar { width: 8px; }
        #chat-container::-webkit-scrollbar-track { background: #1F2A44; }
        #chat-container::-webkit-scrollbar-thumb { background: #00F0FF; border-radius: 4px; border: 2px solid #293345; }
        .sidebar-scroll-container::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll-container::-webkit-scrollbar-thumb { background: #00F0FF; border-radius: 2px; }
        .sidebar-scroll-container::-webkit-scrollbar-track { background: transparent; }

        /* ──────────────────────── 5. Prose ──────────────────────── */
        .prose { color: #E0E6E9; }
        .prose p { margin-top: 0.5em; margin-bottom: 0.5em; } 
        .prose ul { list-style-type: disc; margin-left: 1.5rem; }
        .prose ol { list-style-type: decimal; margin-left: 1.5rem; }
        .prose strong { font-weight: 700; color: #FF8C00; } 
        .prose a { color: #00F0FF; text-decoration: underline; } 
        .prose pre { background-color: #0A111A; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; border: 1px solid #00F0FF; } 
        .prose code { font-family: 'Share Tech Mono', monospace; }
        .prose blockquote { border-left: 4px solid #FF8C00; padding-left: 1em; color: #9CA3AF; }

        /* ──────────────────────── 6. Sidebar / Nodes ──────────────────────── */
        .sidebar-button, .node-link {
            display: flex; align-items: center; width: 100%; padding: 0.75rem 1.5rem;
            border-radius: 0.25rem; font-weight: 500; color: #A0AEC0;
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-button:hover, .node-link:hover {
            background-color: #1F2A44; color: #E0E6E9;
        }
        .ai-message { background: #293345; border: 1px solid rgba(0,240,255,0.1); }
        .user-message { background-color: #FF8C00; color: #151D2A; font-weight: 700; }

        /* ──────────────────────── 7. Mobile Sidebar ──────────────────────── */
        #mobile-sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        #mobile-sidebar { transition: transform 0.3s ease-in-out; transform: translateX(-100%); background:#151D2A; }

        /* ──────────────────────── 8. Chat Layout (critical) ──────────────────────── */
        #chat-panel { display:flex; flex-direction:column; height:100%; }
        #chat-container { flex-grow:1; overflow-y:auto; min-height:0; padding-bottom:2rem; }
        #chat-form-container { 
            position:sticky; bottom:0; background:#151D2A; padding:1rem; z-index:10;
        }
        @media (max-width:767px){
            #chat-container{padding-bottom:11rem;}
            #chat-form-container{
                position:fixed; bottom:0; left:0; right:0;
                padding:0.75rem; box-shadow:0 -2px 4px rgba(0,0,0,0.1); z-index:20;
            }
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden"> 

    <!-- ==================== HEADER ==================== -->
    <header class="py-6 px-4 md:px-8 flex justify-between items-center bg-[#151D2A]/90 backdrop-blur-sm fixed w-full top-0 z-30 shadow-lg flex-shrink-0 border-b border-[#00F0FF]/30">
        <div class="flex items-center gap-3">
            <button id="mobile-menu-open-button" class="md:hidden p-1 text-[#00F0FF] hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
            <a href="/dashboard.html" class="flex items-center gap-3 transition-opacity hover:opacity-90">
                <svg class="w-8 h-8 accent-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.4-8.4h-1m-16 0H3m15.55-5.55l-.71-.71M6.16 17.84l-.71-.71m12.39-.71l-.71.71M6.16 6.16l-.71.71M12 5a7 7 0 100 14 7 7 0 000-14z"/></svg>
                <span class="hidden md:block text-2xl font-bold text-white">Cogmatiq</span>
            </a>
        </div>
        <div class="flex items-center gap-4">
            <span id="cortex-name" class="text-[#00F0FF] font-semibold text-sm md:text-base">The Synthesist</span>
            <a href="/integrations.html" class="text-sm font-semibold accent-primary hover:underline whitespace-nowrap">+ Tools</a>
            <a href="/dashboard.html" class="text-[#A0AEC0] font-medium hover:text-white transition-colors text-sm">Nodes</a>
            <a href="/library.html" class="text-[#A0AEC0] font-medium hover:text-white transition-colors text-sm">Library</a>
            <a href="/account.html" class="text-[#A0AEC0] font-medium hover:text-white transition-colors text-sm">Account</a>
        </div>
    </header>

    <!-- ==================== MAIN LAYOUT ==================== -->
    <div class="flex flex-grow pt-24 overflow-hidden"> 
        
        <!-- ==== DESKTOP SIDEBAR ==== -->
        <aside class="hidden md:flex flex-col w-64 fixed h-full pt-6 px-4 border-r border-[#00F0FF]/30 bg-[#151D2A]">
            <div class="flex-shrink-0 p-4 border-b border-[#00F0FF]/30"><div id="account-status-desktop"><p class="text-sm text-gray-500">INIT: Account Status</p></div></div>
            <div class="flex-shrink-0 pt-4">
                <h3 class="text-xs uppercase text-[#FF8C00] font-semibold px-4 mb-2">Interface</h3>
                <nav class="flex flex-col space-y-2">
                    <a href="/synthesist.html" class="node-link" style="background:#293345;color:#E0E6E9;border-left:2px solid #FF8C00;">
                        <svg class="w-5 h-5 mr-3 accent-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.4-8.4h-1m-16 0H3m15.55-5.55l-.71-.71M6.16 17.84l-.71-.71m12.39-.71l-.71.71M6.16 6.16l-.71.71M12 5a7 7 0 100 14 7 7 0 000-14z"/></svg>
                        SYNTHESIST
                    </a>
                </nav>
            </div>
            <div class="border-t border-[#00F0FF]/30 my-4"></div>
            <div class="flex justify-between items-center flex-shrink-0 px-4 mb-2">
                <h3 class="text-xs uppercase text-[#FF8C00] font-semibold">Knowledge Nodes</h3>
                <a href="/dashboard.html" title="Manage Nodes" class="text-[#00F0FF] hover:text-white"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg></a>
            </div>
            <nav id="cortex-list-sidebar" class="flex-grow overflow-y-auto space-y-1 sidebar-scroll-container"><p class="text-gray-500 text-sm px-4 py-2">LOAD: Fetching Nodes...</p></nav>
        </aside>

        <!-- ==== MOBILE SIDEBAR ==== -->
        <div id="mobile-sidebar-overlay" class="md:hidden fixed inset-0 bg-black/50 z-40 opacity-0 hidden"></div>
        <aside id="mobile-sidebar" class="md:hidden fixed inset-y-0 left-0 w-64 h-full pt-24 p-4 border-r border-[#00F0FF]/30 bg-[#151D2A] z-50 flex flex-col">
            <button id="mobile-menu-close-button" class="absolute top-6 right-4 p-2 text-[#00F0FF] hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            <div class="flex-shrink-0 p-4 border-b border-[#00F0FF]/30"><div id="account-status-mobile"><p class="text-sm text-gray-500">INIT: Account Status</p></div></div>
            <div class="flex-shrink-0 mt-6">
                <h3 class="text-xs uppercase text-[#FF8C00] font-semibold px-4 mb-2">Interface</h3>
                <nav class="flex flex-col space-y-2">
                    <a href="/synthesist.html" class="node-link" style="background:#293345;color:#E0E6E9;border-left:2px solid #FF8C00;">
                        <svg class="w-5 h-5 mr-3 accent-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.4-8.4h-1m-16 0H3m15.55-5.55l-.71-.71M6.16 17.84l-.71-.71m12.39-.71l-.71.71M6.16 6.16l-.71.71M12 5a7 7 0 100 14 7 7 0 000-14z"/></svg>
                        SYNTHESIST
                    </a>
                </nav>
            </div>
            <div class="border-t border-[#00F0FF]/30 my-4"></div>
            <div class="flex justify-between items-center flex-shrink-0 px-4 mb-2">
                <h3 class="text-xs uppercase text-[#FF8C00] font-semibold">Knowledge Nodes</h3>
                <a href="/dashboard.html" title="Manage Nodes" class="text-[#00F0FF] hover:text-white"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg></a>
            </div>
            <nav id="mobile-cortex-list-sidebar" class="flex-grow overflow-y-auto space-y-1 sidebar-scroll-container"><p class="text-sky-500 text-sm px-4 py-2">LOAD: Fetching Nodes...</p></nav>
        </aside>

        <!-- ==== MAIN CHAT AREA ==== -->
        <main class="flex flex-col w-full md:pl-64 h-full" onclick="closeMobileMenu()">
            <div id="chat-panel" class="flex flex-col h-full">
                <div id="chat-container" class="flex-grow overflow-y-auto px-4 md:px-8 space-y-6"></div>

                <!-- INPUT FORM (sticky on desktop, fixed on mobile) -->
                <div id="chat-form-container" class="flex-shrink-0">
                    <form id="chat-form" class="flex items-center gap-4">
                        <input type="text" id="message-input" placeholder="Ask the Synthesist..." required autocomplete="off"
                               class="flex-grow p-4 bg-[#293345] border border-[#00F0FF]/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF8C00] text-white">
                        <button type="submit" id="submit-button" class="btn-primary text-white p-4 rounded-lg transition-colors duration-300 disabled:opacity-50 flex-shrink-0">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
                        </button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- ==================== JAVASCRIPT ==================== -->
    <script>
        // apiBaseUrl & supabaseClient come from /supabaseClient.js
        const API_ENDPOINT          = `${apiBaseUrl}/synthesist/query`;
        const NODES_API_ENDPOINT    = `${apiBaseUrl}/synthesist/nodes`;
        const HISTORY_API_ENDPOINT  = `${apiBaseUrl}/synthesist/history`;
        const STATUS_API_ENDPOINT   = `${apiBaseUrl}/subscription-status`;

        // DOM
        const chatContainer      = document.getElementById('chat-container');
        const chatForm           = document.getElementById('chat-form');
        const messageInput       = document.getElementById('message-input');
        const submitButton       = document.getElementById('submit-button');
        const desktopCortexList  = document.getElementById('cortex-list-sidebar');
        const desktopAccount     = document.getElementById('account-status-desktop');
        const mobileCortexList   = document.getElementById('mobile-cortex-list-sidebar');
        const mobileAccount      = document.getElementById('account-status-mobile');
        const mobileMenuOpenBtn  = document.getElementById('mobile-menu-open-button');
        const mobileMenuCloseBtn = document.getElementById('mobile-menu-close-button');
        const mobileSidebar      = document.getElementById('mobile-sidebar');
        const mobileOverlay      = document.getElementById('mobile-sidebar-overlay');

        // State
        let userToken = null;
        let chatHistory = [];
        let allKnowledgeNodes = [];

        /* ---------- FETCH HELPERS ---------- */
        async function fetchApi(endpoint, opts = {}) {
            if (!userToken) throw new Error("Auth token missing");
            const headers = { ...opts.headers, Authorization: `Bearer ${userToken}` };
            const res = await fetch(endpoint, { ...opts, headers });
            if (!res.ok) {
                let msg = `API Error ${res.status}`;
                try { const j = await res.json(); msg = j.detail || msg; } catch {}
                throw new Error(msg);
            }
            return res.status >= 200 && res.status < 300 ? res.json() : null;
        }

        /* ---------- SCROLL ---------- */
        function scrollChatToBottom() {
            requestAnimationFrame(() => {
                const form = document.getElementById('chat-form-container');
                const extra = form ? form.offsetHeight : 0;
                chatContainer.scrollTo({ top: chatContainer.scrollHeight + extra, behavior: 'smooth' });
            });
        }

        /* ---------- HISTORY ---------- */
        async function fetchChatHistory() {
            if (!userToken) {
                addMessageToUI("I am the Synthesist. Ask me anything, and I will query all your Knowledge Nodes to find an answer.", 'ai');
                return;
            }
            chatContainer.innerHTML = '<p id="history-loading" class="text-gray-500 text-center italic mt-10">LOAD: Fetching Chat History...</p>';
            try {
                const data = await fetchApi(HISTORY_API_ENDPOINT);
                document.getElementById('history-loading')?.remove();
                chatHistory = data.messages || [];
                if (!chatHistory.length) {
                    addMessageToUI("I am the Synthesist. Ask me anything, and I will query all your Knowledge Nodes to find an answer.", 'ai');
                } else {
                    chatHistory.forEach(m => addMessageToUI(m.content, m.role));
                }
                scrollChatToBottom();
            } catch (e) {
                console.error(e);
                addMessageToUI(`ERR: Could not load history. ${e.message}. You can still chat.`, 'ai');
                scrollChatToBottom();
            }
        }

        /* ---------- NODES & STATUS ---------- */
        async function fetchAndRenderNodes() {
            try { allKnowledgeNodes = await fetchApi(NODES_API_ENDPOINT); renderNodeSidebarList(); }
            catch (e) { console.error(e); desktopCortexList.innerHTML = mobileCortexList.innerHTML = `<p class="text-red-400 text-sm px-4 py-2">ERR: Failed to load Nodes</p>`; }
        }
        async function fetchAndRenderSubscriptionStatus() {
            try { const d = await fetchApi(STATUS_API_ENDPOINT); renderSubscriptionStatus(d.is_pro); }
            catch { renderSubscriptionStatus(null, true); }
        }

        function renderNodeSidebarList() {
            if (!allKnowledgeNodes?.length) {
                const html = `<p class="text-gray-500 text-sm px-4 py-2">NODES: None found. <a href="/dashboard.html" class="accent-secondary hover:underline">Create one</a> or <a href="/integrations.html" class="accent-secondary hover:underline">connect one</a>.</p>`;
                desktopCortexList.innerHTML = mobileCortexList.innerHTML = html;
                return;
            }
            const list = allKnowledgeNodes.map(node => {
                const icon = node.node_type === 'cortex'
                    ? `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.253"/></svg>`
                    : `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h10a2 2 0 002-2v-1a2 2 0 012-2h1.945M7.8 9.8l.22.22M12 6v.01M16.2 9.8l-.22.22M18.945 11H19a2 2 0 012 2v1a2 2 0 01-2 2h-1M5.055 11H5a2 2 0 00-2 2v1a2 2 0 002 2h1m0-6a9 9 0 0118 0v0"/></svg>`;
                return `<div class="node-link" title="${node.description || node.name}"><span class="accent-secondary">${icon}</span><span class="truncate">${node.name}</span></div>`;
            }).join('');
            desktopCortexList.innerHTML = mobileCortexList.innerHTML = list;
        }

        function renderSubscriptionStatus(isPro, err = false) {
            let html = err ? `<p class="text-sm text-red-400">STATUS: FAILED</p>`
                : isPro ? `<div><p class="text-sm font-semibold accent-secondary">PLAN: PRO</p><a href="/account.html" class="text-xs text-[#FF8C00] hover:underline">ACCESS: FULL</a></div>`
                : `<div><p class="text-sm font-semibold text-[#A0AEC0]">PLAN: FREE</p><a href="/pricing.html" class="text-sm font-semibold accent-primary hover:underline">ACTION: UPGRADE</a></div>`;
            desktopAccount.innerHTML = mobileAccount.innerHTML = html;
        }

        /* ---------- AUTH & INIT ---------- */
        function initializeChat() {
            supabaseClient.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_OUT') { window.location.href = '/login.html'; return; }
                if (session?.access_token) {
                    if (userToken !== session.access_token) {
                        userToken = session.access_token;
                        initializeListeners();
                        fetchChatHistory();
                        fetchAndRenderNodes();
                        fetchAndRenderSubscriptionStatus();
                    }
                } else if (event === 'INITIAL_SESSION') { window.location.href = '/login.html'; }
            });
        }

        function initializeListeners() {
            if (chatForm.dataset.listener) return;
            mobileMenuOpenBtn.addEventListener('click', openMobileMenu);
            mobileMenuCloseBtn.addEventListener('click', closeMobileMenu);
            mobileOverlay.addEventListener('click', closeMobileMenu);
            chatForm.addEventListener('submit', handleChatSubmit);
            chatForm.dataset.listener = 'true';
        }

        /* ---------- MOBILE MENU ---------- */
        function openMobileMenu() {
            mobileOverlay.classList.remove('hidden');
            requestAnimationFrame(() => { mobileOverlay.classList.remove('opacity-0'); mobileSidebar.style.transform = 'translateX(0)'; });
        }
        function closeMobileMenu() {
            mobileOverlay.classList.add('opacity-0');
            mobileSidebar.style.transform = 'translateX(-100%)';
            setTimeout(() => mobileOverlay.classList.add('hidden'), 300);
        }

        /* ---------- CHAT SUBMIT (streaming) ---------- */
        async function handleChatSubmit(e) {
            e.preventDefault();
            const q = messageInput.value.trim();
            if (!q || !userToken) return;

            addMessageToUI(q, 'user');
            chatHistory.push({ role: 'user', content: q });
            messageInput.value = '';
            submitButton.disabled = true;

            const aiEl = addMessageToUI('', 'ai');

            const fd = new FormData();
            fd.append('question', q);
            fd.append('chat_history_json', JSON.stringify(chatHistory.slice(0,-1).slice(-10)));

            try {
                const res = await fetch(API_ENDPOINT, { method: 'POST', headers: { Authorization: `Bearer ${userToken}` }, body: fd });
                if (!res.ok) throw new Error(await res.text() || 'Stream failed');

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let full = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    full += decoder.decode(value);
                    updateAIMessage(aiEl, full, true);
                }
                chatHistory.push({ role: 'ai', content: full });
            } catch (err) {
                const msg = `ERROR: Process terminated. ${err.message}. Please check your Knowledge Nodes.`;
                updateAIMessage(aiEl, msg);
                chatHistory.push({ role: 'ai', content: msg });
            } finally {
                submitButton.disabled = false;
                messageInput.focus();
                updateAIMessage(aiEl, null, false, true);
            }
        }

        /* ---------- MESSAGE UI ---------- */
        function addMessageToUI(text, sender) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex items-start gap-3 mb-4 message-wrapper';
            wrapper.dataset.role = sender;
            wrapper.dataset.content = text;

            if (sender === 'user') {
                wrapper.classList.add('justify-end');
                const div = document.createElement('div');
                div.className = 'user-message rounded-lg p-4 max-w-lg';
                div.innerHTML = text.replace(/\n/g, '<br>');
                wrapper.appendChild(div);
            } else {
                const icon = document.createElement('div');
                icon.className = 'bg-[#293345] p-2 rounded-full flex-shrink-0 border border-[#00F0FF]';
                icon.innerHTML = `<svg class="w-6 h-6 accent-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.4-8.4h-1m-16 0H3m15.55-5.55l-.71-.71M6.16 17.84l-.71-.71m12.39-.71l-.71.71M6.16 6.16l-.71.71M12 5a7 7 0 100 14 7 7 0 000-14z"/></svg>`;

                const msg = document.createElement('div');
                msg.className = 'ai-message rounded-lg p-4 max-w-lg w-full';
                if (text === '') {
                    msg.innerHTML = `
                        <div class="typing-indicator flex items-center space-x-1">
                            <span class="w-2 h-2 bg-white rounded-full animate-pulse [animation-delay:-0.3s]"></span>
                            <span class="w-2 h-2 bg-white rounded-full animate-pulse [animation-delay:-0.15s]"></span>
                            <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
                        </div>
                        <div class="prose max-w-none response-content hidden"></div>
                        <button class="copy-button hidden mt-3 text-xs text-gray-400 hover:text-[#00F0FF] font-semibold" onclick="copyToClipboard(this)">Copy</button>`;
                } else {
                    msg.innerHTML = `
                        <div class="typing-indicator hidden"></div>
                        <div class="prose max-w-none response-content"></div>
                        <button class="copy-button mt-3 text-xs text-gray-400 hover:text-[#00F0FF] font-semibold" onclick="copyToClipboard(this)">Copy</button>`;
                    msg.querySelector('.response-content').innerHTML = marked.parse(text, { sanitize: false });
                }
                wrapper.append(icon, msg);
            }
            chatContainer.appendChild(wrapper);
            scrollChatToBottom();
            return wrapper;
        }

        function updateAIMessage(el, txt, streaming = false, finalize = false) {
            const ti = el.querySelector('.typing-indicator');
            const rc = el.querySelector('.response-content');
            const cp = el.querySelector('.copy-button');

            if (streaming) {
                ti?.classList.add('hidden');
                rc.classList.remove('hidden');
                el.dataset.content = txt;
                rc.innerHTML = marked.parse(txt);
            } else if (finalize) {
                ti?.classList.add('hidden');
                cp?.classList.remove('hidden');
                rc.innerHTML = marked.parse(el.dataset.content || '');
            } else {
                el.dataset.content = txt;
                ti?.classList.add('hidden');
                rc.innerHTML = marked.parse(txt || 'No response received.', { sanitize: false });
                rc.classList.remove('hidden');
                cp?.classList.remove('hidden');
            }
            scrollChatToBottom();
        }

        function copyToClipboard(btn) {
            const txt = btn.parentElement.querySelector('.response-content')?.innerText;
            if (!txt) return;
            navigator.clipboard.writeText(txt).then(() => {
                btn.textContent = 'COPIED!';
                setTimeout(() => btn.textContent = 'Copy', 2000);
            }).catch(() => {
                btn.textContent = 'COPY FAILED';
                setTimeout(() => btn.textContent = 'Copy', 2000);
            });
        }

        /* ---------- GLOBAL ---------- */
        window.openMobileMenu = openMobileMenu;
        window.closeMobileMenu = closeMobileMenu;
        window.copyToClipboard = copyToClipboard;

        initializeChat();
    </script>
</body>
</html>